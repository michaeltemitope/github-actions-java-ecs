name: Java CI/CD Pipeline
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

env:
  AWS_REGION: us-east-1
  ECR_REPO: <get-from-aws>
  IMAGE_NAME: temi-app
  IMAGE_TAG: ${{ github.run_number }}

jobs:

  # -----------------------------------------------------
  # 1. BUILD JOB
  # -----------------------------------------------------
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Set Up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build Application (Skip Tests)
        run: mvn -B clean package -DskipTests=true

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: target/*.war

  # -----------------------------------------------------
  # 2. UNIT TESTS JOB
  # -----------------------------------------------------
  unit-tests:
    name: Run Unit Tests + Coverage
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Unit Tests With Coverage
        run: mvn -B verify

      - name: Upload Jacoco Report (if exists)
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/
          if-no-files-found: ignore

      - name: Upload JUnit Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: junit-results
          path: target/surefire-reports/


  # -----------------------------------------------------
  # 3. CHECKSTYLE JOB
  # -----------------------------------------------------
  checkstyle:
    name: Checkstyle Analysis
    needs: unit-tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Checkstyle
        run: mvn checkstyle:check || true

      - name: Upload Checkstyle Report
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: target/checkstyle-result.xml
          if-no-files-found: ignore


  # -----------------------------------------------------
  # 4. SONARCLOUD SCAN
  # -----------------------------------------------------
  sonar:
    name: SonarCloud Static Code Analysis
    needs: 
      - checkstyle
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download Jacoco Report
        uses: actions/download-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/

      - name: Download JUnit Reports
        uses: actions/download-artifact@v4
        with:
          name: junit-results
          path: target/surefire-reports/

      - name: Download Checkstyle Report
        uses: actions/download-artifact@v4
        with:
          name: checkstyle-report
          path: target/

      - name: Sonar scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn clean verify sonar:sonar \
          -Dsonar.java.binaries=target/classes \
          -Dsonar.junit.reportPaths=target/surefire-reports \
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
          -Dsonar.externalRules.checkstyle.reportPaths=target/checkstyle-result.xml \
          -Dsonar.organization=cloud-temitope \
          -Dsonar.projectKey=cloud-temitope-trial \
          -Dsonar.projectVersion=1.0 \
          -Dsonar.sources=src/main/java \
          -Dsonar.tests=src/test/java \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
        
      - name: Notify Slack on Quality Gate Failure
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: "#FF0000"
          SLACK_MESSAGE: |
            ‚ùå *Quality Gate Failed*
            ‚Ä¢ Repo: ${{ github.repository }}
            ‚Ä¢ Branch: ${{ github.ref_name }}
            ‚Ä¢ Commit: ${{ github.sha }}
            ‚Ä¢ Triggered by: ${{ github.actor }}
            üîç View Sonar Report: https://sonarcloud.io/project/overview?id=cloud-temitope
            üìÑ Workflow Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        if: failure()
        uses: rtCamp/action-slack-notify@v2

  # -----------------------------------------------------
  # 5. BUILD IMAGE + TRIVY + TAG IMAGE + PUSH TO ECR
  # -----------------------------------------------------
  docker:
    name: Build Docker Image + Scan + Tag Image + Push to ECR
    needs: sonar
    runs-on: ubuntu-latest

    permissions:
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker Image
        run: |
          docker build -t $IMAGE_NAME:$IMAGE_TAG .

      - name: Image Tag
        run: docker tag $ECR_REPO

      - name: Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}
          severity: HIGH,CRITICAL
          exit-code: 0

      - name: Push Image to ECR
        run: |
          docker push $ECR_REPO:$IMAGE_TAG


  # -----------------------------------------------------
  # 6. DEPLOY TO ECS
  # -----------------------------------------------------
  deploy:
    name: Deploy to Amazon ECS
    needs: docker
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}

      - name: Deploy New Image to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ecs/task-def.json
          service: myapp-service
          cluster: myapp-cluster
          image: ${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}

  # -----------------------------------------------------
  # 7. SLACK NOTIFICATION JOB  
  #    ‚úì Runs ONLY if all previous jobs succeed
  # -----------------------------------------------------
  notify-slack:
    runs-on: ubuntu-latest

    # This ensures ALL 6 jobs must succeed before this runs
    needs: 
      - build
      - unit-tests
      - checkstyle
      - sonar
      - docker
      - deploy

    # Runs ONLY when previous jobs succeeded
    if: ${{ success() }}

    steps:
      - name: Send Slack Success Notification
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\":white_check_mark: GitHub Actions workflow *completed successfully* on branch *${GITHUB_REF_NAME}*\"}" \
          $SLACK_WEBHOOK

